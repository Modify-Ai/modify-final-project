# ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ

## ê°œìš”
ì‚¬ìš©ìê°€ ê²€ìƒ‰ ì‹œ ì›í•˜ì§€ ì•ŠëŠ” ìŠ¤íƒ€ì¼ì´ë‚˜ íŠ¹ì§•ì„ ëª…ì‹œí•˜ì—¬ ë” ì •í™•í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” **ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸** ê¸°ëŠ¥ì´ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.

## ì£¼ìš” ê¸°ëŠ¥

### âœ… ë„¤ê±°í‹°ë¸Œ í•„í„°ë§
- ì‚¬ìš©ìê°€ ì œì™¸í•˜ê³  ì‹¶ì€ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ìƒí’ˆì„ ìë™ìœ¼ë¡œ í•„í„°ë§
- ìƒí’ˆëª…, ì„¤ëª…, ì¹´í…Œê³ ë¦¬ì—ì„œ ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œ ê²€ìƒ‰
- ì—¬ëŸ¬ í‚¤ì›Œë“œë¥¼ ì‰¼í‘œ(,), ìŠ¬ë˜ì‹œ(/), ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥ ê°€ëŠ¥

### ğŸ“ ì ìš© ë²”ìœ„
- âœ… AI ê²€ìƒ‰ (`/api/v1/search/ai-search`)
- âœ… CLIP ì´ë¯¸ì§€ ê²€ìƒ‰ (`/api/v1/search/search-by-clip`)

## ì‚¬ìš© ì˜ˆì‹œ

### 1. ê²€ìƒ‰ UI
ê²€ìƒ‰ì°½ ì•„ë˜ì— ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì…ë ¥ í•„ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ì¥ì›ì˜ ê³µí•­ íŒ¨ì…˜              ğŸ¤ ê²€ìƒ‰  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ– ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ, ìºì£¼ì–¼      ì´ˆê¸°í™”    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

**ì‹œë‚˜ë¦¬ì˜¤ 1: í¬ë©€í•œ ìŠ¤íƒ€ì¼ë§Œ ê²€ìƒ‰**
- ê²€ìƒ‰ì–´: "ì—¬ì„± ì½”íŠ¸"
- ë„¤ê±°í‹°ë¸Œ: "ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ, ìºì£¼ì–¼"
- ê²°ê³¼: ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ, ìºì£¼ì–¼ì´ í¬í•¨ë˜ì§€ ì•Šì€ í¬ë©€í•œ ì½”íŠ¸ë§Œ í‘œì‹œ

**ì‹œë‚˜ë¦¬ì˜¤ 2: íŠ¹ì • ìƒ‰ìƒ ì œì™¸**
- ê²€ìƒ‰ì–´: "ì›í”¼ìŠ¤"
- ë„¤ê±°í‹°ë¸Œ: "ê²€ì€ìƒ‰, ë¸”ë™, black"
- ê²°ê³¼: ê²€ì€ìƒ‰ ì›í”¼ìŠ¤ ì œì™¸

**ì‹œë‚˜ë¦¬ì˜¤ 3: íŠ¹ì • ë¸Œëœë“œ/ìŠ¤íƒ€ì¼ ì œì™¸**
- ê²€ìƒ‰ì–´: "ë‚¨ì„± ì¬í‚·"
- ë„¤ê±°í‹°ë¸Œ: "ë°ë‹˜, í›„ë“œ, ìŠ¤í¬ì¸ "
- ê²°ê³¼: ë°ë‹˜/í›„ë“œ/ìŠ¤í¬ì¸  ì¬í‚· ì œì™¸

## ê¸°ìˆ  êµ¬í˜„

### Backend (FastAPI)

#### 1. ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜
```python
def extract_negative_keywords(negative_prompt: Optional[str]) -> List[str]:
    """
    ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ì—ì„œ ì œì™¸í•  í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
    ì˜ˆ: "ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ, ìºì£¼ì–¼" -> ["ì²­ë°”ì§€", "ìŠ¤ë‹ˆì»¤ì¦ˆ", "ìºì£¼ì–¼"]
    """
    if not negative_prompt:
        return []

    keywords = re.split(r'[,/\s]+', negative_prompt.strip())
    return [k.strip().lower() for k in keywords if k.strip()]
```

#### 2. ìƒí’ˆ í•„í„°ë§ í•¨ìˆ˜
```python
def filter_products_by_negative(products: List[Product], negative_keywords: List[str]) -> List[Product]:
    """ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ” ìƒí’ˆ ì œì™¸"""
    if not negative_keywords:
        return products

    filtered = []
    for product in products:
        text_to_check = f"{product.name} {product.description or ''} {product.category or ''}".lower()
        contains_negative = any(keyword in text_to_check for keyword in negative_keywords)

        if not contains_negative:
            filtered.append(product)

    return filtered
```

#### 3. API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •

**AI ê²€ìƒ‰ ì—”ë“œí¬ì¸íŠ¸:**
```python
@router.post("/ai-search")
async def ai_search(
    query: str = Form(...),
    image_file: Optional[UploadFile] = File(None),
    limit: int = Form(12),
    negative_prompt: Optional[str] = Form(None),  # âœ… ì¶”ê°€
    db: AsyncSession = Depends(deps.get_db),
):
    # ... ê²€ìƒ‰ ë¡œì§ ...

    # âœ… ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ í•„í„°ë§
    if negative_prompt:
        negative_keywords = extract_negative_keywords(negative_prompt)
        results = filter_products_by_negative(results, negative_keywords)
```

**CLIP ì´ë¯¸ì§€ ê²€ìƒ‰:**
```python
class ClipSearchRequest(BaseModel):
    image_b64: str
    limit: int = 12
    query: Optional[str] = None
    target: str = "full"
    negative_prompt: Optional[str] = None  # âœ… ì¶”ê°€

@router.post("/search-by-clip")
async def search_by_clip_image(request: ClipSearchRequest, ...):
    # ... CLIP ê²€ìƒ‰ ...

    # âœ… ë„¤ê±°í‹°ë¸Œ í•„í„°ë§ (ë” ë§ì´ ê°€ì ¸ì˜¨ í›„ í•„í„°ë§)
    if request.negative_prompt:
        negative_keywords = extract_negative_keywords(request.negative_prompt)
        results = filter_products_by_negative(results, negative_keywords)
        results = results[:request.limit]
```

### Frontend (React + TypeScript)

#### 1. State ì¶”ê°€
```typescript
const [negativePrompt, setNegativePrompt] = useState<string>("");
```

#### 2. UI ì»´í¬ë„ŒíŠ¸
```tsx
{/* ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì…ë ¥ í•„ë“œ */}
<div className="flex items-center space-x-3 mt-3 pt-3 border-t">
    <X className="w-5 h-5 text-red-400" />
    <input
        type="text"
        value={negativePrompt}
        onChange={(e) => setNegativePrompt(e.target.value)}
        placeholder="ì œì™¸í•  ìŠ¤íƒ€ì¼ (ì˜ˆ: ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ, ìºì£¼ì–¼)"
        className="flex-1 text-sm ..."
    />
    {negativePrompt && (
        <button onClick={() => setNegativePrompt("")}>
            ì´ˆê¸°í™”
        </button>
    )}
</div>
```

#### 3. API í˜¸ì¶œ ìˆ˜ì •
```typescript
const formData = new FormData();
formData.append('query', currentQuery);
if (currentImage) formData.append('image_file', currentImage);
if (negativePrompt) formData.append('negative_prompt', negativePrompt);  // âœ…
formData.append('limit', '12');
```

## ë™ì‘ ì›ë¦¬

### 1. í‚¤ì›Œë“œ ì¶”ì¶œ
```
ì…ë ¥: "ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ / ìºì£¼ì–¼"
â†“
split by [, / ê³µë°±]
â†“
["ì²­ë°”ì§€", "ìŠ¤ë‹ˆì»¤ì¦ˆ", "ìºì£¼ì–¼"]
â†“
ì†Œë¬¸ì ë³€í™˜
â†“
["ì²­ë°”ì§€", "ìŠ¤ë‹ˆì»¤ì¦ˆ", "ìºì£¼ì–¼"]
```

### 2. ìƒí’ˆ í•„í„°ë§
```
ìƒí’ˆ A: "ë¸”ë£¨ ì²­ë°”ì§€ (ë°ë‹˜ íŒ¬ì¸ )" â†’ âŒ ì œì™¸ (ì²­ë°”ì§€ í¬í•¨)
ìƒí’ˆ B: "í™”ì´íŠ¸ ì…”ì¸  (í¬ë©€)" â†’ âœ… í¬í•¨
ìƒí’ˆ C: "ë¸”ë™ ìŠ¤ë‹ˆì»¤ì¦ˆ" â†’ âŒ ì œì™¸ (ìŠ¤ë‹ˆì»¤ì¦ˆ í¬í•¨)
ìƒí’ˆ D: "ë ˆë” êµ¬ë‘" â†’ âœ… í¬í•¨
```

### 3. ê²€ìƒ‰ í”Œë¡œìš°
```
ì‚¬ìš©ì ì…ë ¥
  â†“
ê²€ìƒ‰ì–´: "ì—¬ì„± ì½”íŠ¸"
ë„¤ê±°í‹°ë¸Œ: "ì²­ë°”ì§€, ìºì£¼ì–¼"
  â†“
AI/CLIP ê²€ìƒ‰ (limit * 2ê°œ ê°€ì ¸ì˜´)
  â†“
ë„¤ê±°í‹°ë¸Œ í•„í„°ë§
  â†“
ê²°ê³¼: 12ê°œ ë°˜í™˜
```

## íŒŒì¼ ë³€ê²½ ë‚´ì—­

### Backend
1. **[backend-core/src/api/v1/endpoints/search.py](backend-core/src/api/v1/endpoints/search.py)**
   - `extract_negative_keywords()` í•¨ìˆ˜ ì¶”ê°€
   - `filter_products_by_negative()` í•¨ìˆ˜ ì¶”ê°€
   - `ClipSearchRequest`ì— `negative_prompt` í•„ë“œ ì¶”ê°€
   - `/ai-search` ì—”ë“œí¬ì¸íŠ¸ì— `negative_prompt` íŒŒë¼ë¯¸í„° ì¶”ê°€
   - CLIP ê²€ìƒ‰ ë° AI ê²€ìƒ‰ì— ë„¤ê±°í‹°ë¸Œ í•„í„°ë§ ë¡œì§ ì ìš©

### Frontend
1. **[frontend/src/pages/Search.tsx](frontend/src/pages/Search.tsx)**
   - `negativePrompt` state ì¶”ê°€
   - ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì…ë ¥ UI ì¶”ê°€
   - API í˜¸ì¶œ ì‹œ `negative_prompt` íŒŒë¼ë¯¸í„° ì „ì†¡

## ì‚¬ìš© ë°©ë²•

### 1. ë°±ì—”ë“œ ì¬ì‹œì‘
```bash
docker restart modify-backend
```

### 2. í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
1. http://localhost:5173 ì ‘ì†
2. ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™
3. ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: "ì—¬ì„± ì½”íŠ¸")
4. ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì…ë ¥ (ì˜ˆ: "ì²­ë°”ì§€, ìºì£¼ì–¼")
5. ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
6. ê²°ê³¼ í™•ì¸

### 3. API í…ŒìŠ¤íŠ¸
```bash
# curl í…ŒìŠ¤íŠ¸
curl -X POST "http://localhost:8000/api/v1/search/ai-search" \
  -F "query=ì—¬ì„± ì½”íŠ¸" \
  -F "negative_prompt=ì²­ë°”ì§€, ìºì£¼ì–¼" \
  -F "limit=12"
```

## ì£¼ì˜ì‚¬í•­

### 1. ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œ í˜•ì‹
- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: "ì²­ë°”ì§€, ìŠ¤ë‹ˆì»¤ì¦ˆ, ìºì£¼ì–¼"
- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: "ì²­ë°”ì§€ / ìŠ¤ë‹ˆì»¤ì¦ˆ / ìºì£¼ì–¼"
- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: "ì²­ë°”ì§€ ìŠ¤ë‹ˆì»¤ì¦ˆ ìºì£¼ì–¼"
- âŒ ì˜ëª»ëœ ì˜ˆ: "" (ë¹ˆ ë¬¸ìì—´ì€ ë¬´ì‹œë¨)

### 2. ê²€ìƒ‰ ê²°ê³¼ ìˆ˜
- ë„¤ê±°í‹°ë¸Œ í•„í„°ë§ìœ¼ë¡œ ì¸í•´ ê²°ê³¼ê°€ ì ì–´ì§ˆ ìˆ˜ ìˆìŒ
- CLIP ê²€ìƒ‰ ì‹œ `limit * 2`ê°œë¥¼ ê°€ì ¸ì˜¨ í›„ í•„í„°ë§í•˜ì—¬ ì¶©ë¶„í•œ ê²°ê³¼ ë³´ì¥

### 3. ì„±ëŠ¥
- ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œê°€ ë§ì„ìˆ˜ë¡ í•„í„°ë§ ì‹œê°„ì´ ì•½ê°„ ì¦ê°€í•  ìˆ˜ ìˆìŒ
- í•˜ì§€ë§Œ í‚¤ì›Œë“œ ë§¤ì¹­ì€ ë§¤ìš° ë¹ ë¥´ë¯€ë¡œ ì„±ëŠ¥ ì˜í–¥ì€ ë¯¸ë¯¸í•¨

## í–¥í›„ ê°œì„  ì‚¬í•­
- [ ] ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ìë™ ì™„ì„± ê¸°ëŠ¥
- [ ] ìì£¼ ì‚¬ìš©í•˜ëŠ” ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œ ì €ì¥
- [ ] ë„¤ê±°í‹°ë¸Œ í‚¤ì›Œë“œ ì œì•ˆ (AI ê¸°ë°˜)
- [ ] ë„¤ê±°í‹°ë¸Œ í•„í„°ë§ ê²°ê³¼ í†µê³„ í‘œì‹œ

## ê¸°ìˆ  ìŠ¤íƒ
- **Backend**: FastAPI, Python
- **Frontend**: React, TypeScript, Tailwind CSS
- **Filtering**: ì •ê·œí‘œí˜„ì‹ ê¸°ë°˜ í‚¤ì›Œë“œ ë§¤ì¹­

---

êµ¬í˜„ ì™„ë£Œì¼: 2025-12-11
ì‘ì„±ì: Claude Code Assistant
